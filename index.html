<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Draw v2 - Voice-Powered AI Image Creation</title>
    <!-- 
        Vibe Draw v2 - Enhanced Features:
        - Natural, varied conversational responses
        - Persistent API key storage with opt-in/out
        - Improved edit detection for minor and major changes
        - Special handling for significant edits (e.g., "make it a dog but keep the hat")
        - Microphone permission tip for Chrome/Edge browsers
        - Visual mode indicators (Create/Edit)
        - Debug mode for troubleshooting
        - Settings button for changing API keys
        - Start New button clears both image and conversation with confirmation
        - Clear Saved Keys option in setup
        - Welcome message appears immediately on app load
        - Randomized system messages and tips
        - More personality and natural language throughout
    -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-container {
            flex: 1;
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            gap: 30px;
        }

        .conversation-panel {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }

        .image-panel {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.ai {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            margin-right: auto;
        }

        .message.user {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            margin-left: auto;
            text-align: right;
        }

        .message.system {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.3);
            margin: 0 auto;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
            max-width: 90%;
        }

        .message .speaker {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .voice-button:active {
            transform: scale(0.95);
        }

        .voice-button.listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        .voice-button svg {
            width: 40px;
            height: 40px;
        }

        .status-text {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
            margin-top: 10px;
        }

        .mode-indicator {
            text-align: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: inline-block;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }

        .mode-indicator.create {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.5);
            color: #8b9af5;
        }

        .mode-indicator.edit {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            color: #ffd43b;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .debug-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        .image-display {
            width: 100%;
            max-width: 512px;
            aspect-ratio: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }

        .image-display img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .image-placeholder {
            text-align: center;
            opacity: 0.5;
        }

        .image-placeholder svg {
            width: 100px;
            height: 100px;
            margin-bottom: 10px;
        }

        .generating-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .setup-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 600px;
            margin: 40px auto;
        }

        .setup-panel h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .form-group input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .start-button {
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .start-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .image-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .action-button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .settings-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .settings-button svg {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Vibe Draw v2</h1>
        <p>Speak your imagination into reality with AI</p>
    </header>

    <!-- Setup Panel -->
    <div id="setupPanel" class="setup-panel">
        <h2>Let's Get Started</h2>
        <form class="setup-form" onsubmit="initializeVibeDraw(event)">
            <div class="form-group">
                <label for="elevenlabsKey">ElevenLabs API Key</label>
                <input type="password" id="elevenlabsKey" placeholder="Enter your ElevenLabs API key" required>
            </div>
            
            <div class="form-group">
                <label for="falKey">FAL.ai API Key</label>
                <input type="password" id="falKey" placeholder="Enter your FAL.ai API key" required>
            </div>
            
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 12px;">
                <input type="checkbox" id="rememberKeys" checked style="width: auto; margin: 0;">
                <label for="rememberKeys" style="margin: 0; cursor: pointer;">Remember my API keys</label>
            </div>
            
            <button type="submit" class="start-button">Start Creating</button>
            
            <button type="button" class="action-button" onclick="clearAPIKeys()" style="width: 100%; margin-top: 10px; background: rgba(255, 107, 107, 0.2); border-color: rgba(255, 107, 107, 0.3);" id="clearKeysButton" hidden>
                Clear Saved API Keys
            </button>
            
            <div id="errorMessage" class="error-message"></div>
        </form>
    </div>

    <!-- Main App (Hidden until setup) -->
    <div id="mainApp" class="main-container hidden">
        <!-- Settings Button -->
        <button class="settings-button" onclick="showSettings()" id="settingsButton">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
            Settings
        </button>
        <div class="conversation-panel">
            <h2 style="margin-bottom: 20px;">Conversation</h2>
            <div id="modeIndicator" class="mode-indicator create">Create Mode</div>
            <div class="chat-container" id="chatContainer">
                <!-- Messages will appear here -->
            </div>
            
            <div class="voice-controls">
                <button id="voiceButton" class="voice-button" onclick="toggleListening()">
                    <svg fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                </button>
            </div>
            <div class="status-text" id="statusText">Click the microphone to start talking</div>
        </div>

        <div class="image-panel">
            <h2 style="margin-bottom: 20px;">Your Creation</h2>
            <div class="image-display" id="imageDisplay">
                <div class="image-placeholder">
                    <svg fill="currentColor" viewBox="0 0 24 24" opacity="0.3">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    <p>Your image will appear here</p>
                </div>
            </div>
            <div class="image-actions" id="imageActions" style="display: none;">
                <button class="action-button" onclick="downloadCurrentImage()">Download</button>
                <button class="action-button" onclick="startNewImage()">Start New</button>
            </div>
        </div>
    </div>

    <!-- Debug Toggle -->
    <button class="debug-toggle hidden" onclick="toggleDebug()" id="debugToggle">Debug: OFF</button>

    <script>
        // Response variations for more natural conversation
const responses = {
    welcome: [
        "Hey there! I'm Vibe Draw. What kind of amazing image should we create today?",
        "Hi! Ready to bring your imagination to life? Just tell me what you're picturing!",
        "Hey! I'm here to turn your ideas into images. What's on your mind?",
        "Hello! Describe anything you'd like to see, and I'll make it happen!",
        "Hi there! Let's create something awesome. What are you imagining?"
    ],
    greeting: [
        "Hey! What should we create today?",
        "Hi there! What's on your creative mind?",
        "Hello! Ready to make something cool?",
        "Hey! What are you picturing?",
        "Hi! What would you like to see come to life?"
    ],
    generating: [
        "Ooh, I love that idea! Let me bring it to life...",
        "That sounds awesome! Creating it now...",
        "Great description! Working on it...",
        "I can totally see that! Let me create it...",
        "Love it! Generating your image...",
        "That's going to look amazing! One moment...",
        "Excellent choice! Let me work my magic..."
    ],
    editing: [
        "Got it! Let me tweak that for you...",
        "Sure thing! Making those changes...",
        "No problem! Adjusting it now...",
        "I see what you mean! Let me fix that...",
        "Good idea! Updating the image...",
        "Absolutely! Let me modify that..."
    ],
    bigEdit: [
        "Whoa, that's quite a transformation! Let me see what I can do...",
        "Big changes coming up! This might take a moment...",
        "That's a major shift! I'll do my best...",
        "Interesting challenge! Let me work on that...",
        "Ambitious edit! Let's see how this turns out..."
    ],
    success: [
        "There you go! What do you think?",
        "Boom! How's that looking?",
        "And... done! Like what you see?",
        "Ta-da! Hope you love it!",
        "All set! Pretty cool, right?",
        "Finished! How did I do?"
    ],
    editSuccess: [
        "Updated! Looking better?",
        "Changes applied! How's that?",
        "Modified as requested! What do you think?",
        "There we go! Is that what you had in mind?",
        "Adjusted! Does that work for you?"
    ],
    bigEditSuccess: [
        "Wow, that was quite the transformation! How did it turn out?",
        "Major changes complete! What do you think?",
        "That was a big one! Hope it's what you wanted!",
        "Transformation complete! Did I nail it?"
    ],
    error: [
        "Hmm, I'm having trouble with that. Could you describe it differently?",
        "Oops, something went wrong. Want to try again with different words?",
        "I couldn't quite get that to work. Maybe try describing it another way?",
        "That didn't go as planned. Let's try a different approach?"
    ],
    editError: [
        "That's proving tricky to edit. Want to try a different change?",
        "I'm struggling with that modification. Maybe describe it differently?",
        "Hmm, that edit isn't working out. Should we try something else?"
    ],
    help: [
        "I'm here to create any image you can describe! Just tell me what you want to see. If you already have an image, I can modify it too!",
        "Just describe what you're imagining, and I'll create it! I can also edit existing images - just tell me what changes you want.",
        "Think of me as your artistic friend! Describe any scene, and I'll visualize it. Already have an image? I can edit that too!"
    ],
    newSession: [
        "Fresh start! What should we create this time?",
        "New canvas, new possibilities! What are you thinking?",
        "Starting fresh! What's your next idea?",
        "Clean slate! What do you want to see?",
        "New session! Let's make something amazing!"
    ],
    editPrompt: [
        "Want me to change anything about it?",
        "Any adjustments you'd like?",
        "Need me to tweak anything?",
        "How can I improve it?",
        "What would make it perfect?"
    ]
};

// Helper function to get random response
function getRandomResponse(type) {
    const options = responses[type];
    return options[Math.floor(Math.random() * options.length)];
}
        let recognition;
        let isListening = false;
        let currentImage = null;
        let isGenerating = false;
        let isProcessing = false;
        let conversationHistory = [];
        let elevenlabsApiKey;
        let falApiKey;
        let audioQueue = [];
        let isPlayingAudio = false;
        let debugMode = false;

        // Initialize speech recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window && !recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-GB';
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    handleUserSpeech(transcript);
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'not-allowed') {
                        updateStatus('Microphone access denied. Please enable it in browser settings.');
                    } else {
                        updateStatus('Speech recognition error. Click to try again.');
                    }
                    stopListening();
                };
                
                recognition.onend = () => {
                    stopListening();
                };
            }
        }

        // Check for saved API keys on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedElevenLabsKey = localStorage.getItem('vibeDrawElevenLabsKey');
            const savedFalKey = localStorage.getItem('vibeDrawFalKey');
            
            if (savedElevenLabsKey && savedFalKey) {
                // Auto-initialize if we have saved keys
                elevenlabsApiKey = savedElevenLabsKey;
                falApiKey = savedFalKey;
                
                // Skip setup and go straight to app
                document.getElementById('setupPanel').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('debugToggle').classList.remove('hidden');
                
                // Initialize speech recognition
                initializeSpeechRecognition();
                
                // Add initial message with a slight delay to ensure DOM is ready
                setTimeout(() => {
                    const welcomeMessage = getRandomResponse('welcome');
                    addMessage('ai', welcomeMessage);
                    queueAudioResponse(welcomeMessage);
                }, 100);
            } else {
                // Show setup form with any partially saved keys
                if (savedElevenLabsKey) {
                    document.getElementById('elevenlabsKey').value = savedElevenLabsKey;
                }
                if (savedFalKey) {
                    document.getElementById('falKey').value = savedFalKey;
                }
                
                // Show clear keys button if we have any saved keys
                if (savedElevenLabsKey || savedFalKey) {
                    document.getElementById('clearKeysButton').hidden = false;
                }
            }
        });

        async function initializeVibeDraw(event) {
            event.preventDefault();
            
            elevenlabsApiKey = document.getElementById('elevenlabsKey').value;
            falApiKey = document.getElementById('falKey').value;
            
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
            
            try {
                // Save API keys to localStorage if user wants to remember them
                const rememberKeys = document.getElementById('rememberKeys').checked;
                if (rememberKeys) {
                    localStorage.setItem('vibeDrawElevenLabsKey', elevenlabsApiKey);
                    localStorage.setItem('vibeDrawFalKey', falApiKey);
                } else {
                    // Clear any previously saved keys
                    localStorage.removeItem('vibeDrawElevenLabsKey');
                    localStorage.removeItem('vibeDrawFalKey');
                }
                
                // Show main app
                document.getElementById('setupPanel').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('debugToggle').classList.remove('hidden');
                
                // Initialize speech recognition
                initializeSpeechRecognition();
                
                // Add initial message with a slight delay to ensure DOM is ready
                setTimeout(() => {
                    const welcomeMessage = getRandomResponse('welcome');
                    addMessage('ai', welcomeMessage);
                    queueAudioResponse(welcomeMessage);
                }, 100);
                
            } catch (error) {
                errorDiv.textContent = 'Failed to initialize. Please check your API keys.';
                errorDiv.style.display = 'block';
                console.error('Initialization error:', error);
            }
        }

        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        async function startListening() {
            if (!recognition) {
                updateStatus('Speech recognition not supported in your browser');
                return;
            }
            
            // Initialize recognition if needed
            initializeSpeechRecognition();
            
            try {
                isListening = true;
                document.getElementById('voiceButton').classList.add('listening');
                updateStatus('Listening... speak now');
                
                // Check if we should skip the permission prompt
                const skipPermission = localStorage.getItem('vibeDrawSkipMicPermission');
                if (!skipPermission) {
                    // First time - show a tip
                    setTimeout(() => {
                        const tips = [
                            'Tip: In Chrome/Edge, click the lock icon in the address bar → Site settings → Microphone → Allow. This prevents repeated permission prompts.',
                            'Pro tip: To avoid permission prompts, go to your browser settings and allow microphone access for this site.',
                            'Quick tip: Grant permanent microphone access via your browser settings to skip future prompts!',
                            'Heads up: You can allow microphone permanently in your browser settings to avoid this popup each time.'
                        ];
                        addMessage('system', tips[Math.floor(Math.random() * tips.length)]);
                    }, 2000);
                    localStorage.setItem('vibeDrawSkipMicPermission', 'true');
                }
                
                recognition.start();
            } catch (error) {
                console.error('Failed to start speech recognition:', error);
                stopListening();
                updateStatus('Failed to start listening. Please try again.');
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('voiceButton').classList.remove('listening');
            updateStatus('Click the microphone to speak');
            if (recognition) {
                recognition.stop();
            }
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        function addMessage(speaker, text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${speaker}`;
            
            if (speaker !== 'system') {
                const speakerDiv = document.createElement('div');
                speakerDiv.className = 'speaker';
                speakerDiv.textContent = speaker === 'ai' ? 'Vibe Draw' : 'You';
                messageDiv.appendChild(speakerDiv);
            }
            
            const textDiv = document.createElement('div');
            textDiv.textContent = text;
            messageDiv.appendChild(textDiv);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            conversationHistory.push({ speaker, text, timestamp: new Date() });
        }

        async function handleUserSpeech(transcript) {
            if (isProcessing) return;
            isProcessing = true;
            
            addMessage('user', transcript);
            
            try {
                // Determine intent and execute action
                await processUserIntent(transcript);
            } finally {
                isProcessing = false;
            }
        }

        async function processUserIntent(text) {
            const lower = text.toLowerCase();
            debugLog('🤔 Processing intent for:', text);
            debugLog('Current image exists:', !!currentImage);
            
            // Don't process greetings or help if we're in the middle of a creation session
            if (!currentImage) {
                // Check for greetings only when no image exists
                if (lower.includes('hello') || lower.includes('hi') || lower.includes('hey')) {
                    const response = getRandomResponse('greeting');
                    addMessage('ai', response);
                    queueAudioResponse(response);
                    return;
                }
            }
            
            // Check for help
            if (lower.includes('help')) {
                const response = getRandomResponse('help');
                addMessage('ai', response);
                queueAudioResponse(response);
                return;
            }
            
            // Check if this is a response to a failed significant edit
            const lastHistory = conversationHistory[conversationHistory.length - 1];
            if (lastHistory && lastHistory.type === 'significant_edit_failed') {
                if (lower.includes('yes') || lower.includes('yeah') || lower.includes('ok') || lower.includes('sure') || lower.includes('please')) {
                    // User wants to create a new image based on the failed edit
                    const newPrompt = lastHistory.instruction;
                    debugLog('🆕 Creating new image from failed edit:', newPrompt);
                    await handleGenerateRequest(newPrompt);
                    return;
                }
            }
            
            // Check if we have an image and user wants to edit
            if (currentImage && !isGenerating) {
                // Check for significant change keywords that might not work well with edit
                const significantChangeKeywords = [
                    'make it a ', 'change it to a ', 'turn it into ', 'transform into ',
                    'replace with ', 'but now ', 'instead make it '
                ];
                
                const hasSignificantChange = significantChangeKeywords.some(keyword => lower.includes(keyword));
                
                // Extended edit keywords to catch more variations
                const editKeywords = [
                    'change', 'make', 'add', 'remove', 'edit', 'update', 'turn', 
                    'more', 'less', 'bigger', 'smaller', 'modify', 'adjust', 
                    'replace', 'swap', 'switch', 'convert', 'transform', 'alter',
                    'put', 'place', 'move', 'shift', 'color', 'colour', 'brighten',
                    'darken', 'can you', 'could you', 'would you', 'please', 'but keep',
                    'but maintain', 'but retain', 'keep the', 'maintain the'
                ];
                
                // Also check for context clues that suggest editing
                const contextualEditPhrases = [
                    'it ', 'its ', 'the ', 'that ', 'this ', 'them ', 'their ',
                    'to be', 'instead', 'different', 'another'
                ];
                
                const hasEditKeyword = editKeywords.some(keyword => lower.includes(keyword));
                const hasContextClue = contextualEditPhrases.some(phrase => lower.includes(phrase));
                
                // If user explicitly wants a new image
                const newImageKeywords = ['new', 'create new', 'generate new', 'start over', 'different image', 'something else'];
                const wantsNewImage = newImageKeywords.some(keyword => lower.includes(keyword));
                
                if (wantsNewImage) {
                    debugLog('🆕 Detected as NEW image request');
                    // User wants a completely new image
                    await handleGenerateRequest(text);
                    return;
                }
                
                // If it's a significant change, we might need special handling
                if (hasSignificantChange || (hasEditKeyword && lower.includes('but keep'))) {
                    debugLog('🔄 Detected as SIGNIFICANT EDIT request');
                    // Try edit first, but prepare for potential fallback
                    await handleSignificantEditRequest(text);
                    return;
                }
                
                // If it looks like an edit request, handle it as an edit
                if (hasEditKeyword || hasContextClue) {
                    debugLog('✅ Detected as EDIT request (keywords/context found)');
                    // This is an edit request
                    await handleEditRequest(text);
                    return;
                }
                
                debugLog('🔄 Defaulting to EDIT (ambiguous with existing image)');
                // Default to edit if we have an image and the request is ambiguous
                await handleEditRequest(text);
                return;
            }
            
            // Otherwise, treat as a new image request
            await handleGenerateRequest(text);
        }

        async function handleGenerateRequest(prompt) {
            const response = getRandomResponse('generating');
            addMessage('ai', response);
            queueAudioResponse(response);
            
            // Add system message with variety
            const systemMessages = [
                `Creating: "${prompt}"`,
                `Working on: "${prompt}"`,
                `Generating: "${prompt}"`,
                `Bringing to life: "${prompt}"`
            ];
            addMessage('system', systemMessages[Math.floor(Math.random() * systemMessages.length)]);
            
            await generateImage(prompt);
        }

        async function handleEditRequest(instruction) {
            const response = getRandomResponse('editing');
            addMessage('ai', response);
            queueAudioResponse(response);
            
            // Add system message with variety
            const systemMessages = [
                `Editing: "${instruction}"`,
                `Applying: "${instruction}"`,
                `Modifying: "${instruction}"`,
                `Adjusting: "${instruction}"`
            ];
            addMessage('system', systemMessages[Math.floor(Math.random() * systemMessages.length)]);
            
            await editImage(instruction);
        }

        async function handleSignificantEditRequest(instruction) {
            const response = getRandomResponse('bigEdit');
            addMessage('ai', response);
            queueAudioResponse(response);
            
            // Add system message with variety
            const systemMessages = [
                `Major transformation: "${instruction}"`,
                `Big change: "${instruction}"`,
                `Significant edit: "${instruction}"`,
                `Major modification: "${instruction}"`
            ];
            addMessage('system', systemMessages[Math.floor(Math.random() * systemMessages.length)]);
            
            // For significant changes, we'll use a hybrid approach
            await editImageWithFallback(instruction);
        }

        async function generateImage(prompt) {
            if (isGenerating) return;
            
            debugLog('🎨 Generating new image with prompt:', prompt);
            updateModeIndicator('create');
            
            isGenerating = true;
            showGeneratingOverlay('Creating your image...');
            
            try {
                // Enhance the prompt
                const enhancedPrompt = await enhancePrompt(prompt);
                debugLog('Enhanced prompt:', enhancedPrompt);
                
                const endpoint = 'https://fal.run/fal-ai/flux-pro/kontext/text-to-image';
                debugLog('Using endpoint:', endpoint);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Key ${falApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: enhancedPrompt,
                        guidance_scale: 3.5,
                        num_images: 1,
                        safety_tolerance: "2",
                        output_format: "jpeg"
                    })
                });

                if (!response.ok) {
                    throw new Error('Image generation failed');
                }

                const result = await response.json();
                if (result.images && result.images.length > 0) {
                    currentImage = result.images[0].url;
                    displayImage(currentImage);
                    
                    const successMsg = getRandomResponse('success');
                    addMessage('ai', successMsg);
                    queueAudioResponse(successMsg);
                    
                    // Sometimes add an edit prompt
                    if (Math.random() > 0.7) {
                        setTimeout(() => {
                            const editPrompt = getRandomResponse('editPrompt');
                            addMessage('ai', editPrompt);
                            queueAudioResponse(editPrompt);
                        }, 3000);
                    }
                }
                
            } catch (error) {
                console.error('Error generating image:', error);
                const errorMsg = getRandomResponse('error');
                addMessage('ai', errorMsg);
                queueAudioResponse(errorMsg);
            } finally {
                isGenerating = false;
                hideGeneratingOverlay();
            }
        }

        async function editImage(instruction) {
            if (!currentImage || isGenerating) return;
            
            debugLog('✂️ Editing image with instruction:', instruction);
            debugLog('Current image URL:', currentImage);
            updateModeIndicator('edit');
            
            isGenerating = true;
            showGeneratingOverlay('Applying your changes...');
            
            try {
                const endpoint = 'https://fal.run/fal-ai/flux-pro/kontext';
                debugLog('Using edit endpoint:', endpoint);
                
                const requestBody = {
                    prompt: instruction,
                    image_url: currentImage,
                    guidance_scale: 3.5,
                    num_images: 1,
                    safety_tolerance: "2",
                    output_format: "jpeg"
                };
                debugLog('Request body:', requestBody);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Key ${falApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('Image editing failed');
                }

                const result = await response.json();
                if (result.images && result.images.length > 0) {
                    currentImage = result.images[0].url;
                    displayImage(currentImage);
                    
                    const successMsg = getRandomResponse('editSuccess');
                    addMessage('ai', successMsg);
                    queueAudioResponse(successMsg);
                }
                
            } catch (error) {
                console.error('Error editing image:', error);
                const errorMsg = getRandomResponse('editError');
                addMessage('ai', errorMsg);
                queueAudioResponse(errorMsg);
            } finally {
                isGenerating = false;
                hideGeneratingOverlay();
            }
        }

        async function enhancePrompt(basicPrompt) {
            // Simple enhancement - in production, use FAL's any-llm
            let enhanced = basicPrompt;
            
            // Add quality modifiers if the prompt is simple
            if (basicPrompt.split(' ').length < 5) {
                enhanced += ', detailed, high quality, beautiful lighting';
            }
            
            return enhanced;
        }

        async function editImageWithFallback(instruction) {
            if (!currentImage || isGenerating) return;
            
            debugLog('🔄 Attempting significant edit with instruction:', instruction);
            debugLog('Current image URL:', currentImage);
            updateModeIndicator('edit');
            
            isGenerating = true;
            showGeneratingOverlay('Applying major changes...');
            
            try {
                // First, try the normal edit endpoint
                const endpoint = 'https://fal.run/fal-ai/flux-pro/kontext';
                debugLog('Trying kontext edit endpoint first:', endpoint);
                
                // Enhanced instruction for better results
                const enhancedInstruction = instruction + ", maintain the composition and style but apply the requested changes";
                
                const requestBody = {
                    prompt: enhancedInstruction,
                    image_url: currentImage,
                    guidance_scale: 4.5, // Slightly higher for more dramatic changes
                    num_images: 1,
                    safety_tolerance: "2",
                    output_format: "jpeg"
                };
                debugLog('Request body:', requestBody);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Key ${falApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('Image editing failed');
                }

                const result = await response.json();
                if (result.images && result.images.length > 0) {
                    currentImage = result.images[0].url;
                    displayImage(currentImage);
                    
                    const successMsg = getRandomResponse('bigEditSuccess');
                    addMessage('ai', successMsg);
                    queueAudioResponse(successMsg);
                    
                    // Add a helpful tip
                    if (Math.random() > 0.5) {
                        setTimeout(() => {
                            const tips = [
                                "Tip: For major subject changes, sometimes creating a new image gives better results.",
                                "Pro tip: Big transformations work best when starting fresh!",
                                "Just so you know: Major edits can be tricky - starting new often works better.",
                                "Fun fact: The AI loves fresh starts for big changes!"
                            ];
                            addMessage('system', tips[Math.floor(Math.random() * tips.length)]);
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('Error with significant edit:', error);
                
                // If edit fails, suggest creating a new image
                const fallbackOptions = [
                    "Hmm, that's a pretty dramatic change! For best results, how about we create a fresh image? Want me to do that?",
                    "That transformation is proving tricky! I think starting fresh would work better. Should I create a new image based on what you described?",
                    "This edit is quite ambitious! Sometimes it's better to start from scratch. Want me to create a new version?",
                    "That's a big ask for an edit! I'd recommend creating it fresh. Shall I?"
                ];
                const fallbackMsg = fallbackOptions[Math.floor(Math.random() * fallbackOptions.length)];
                addMessage('ai', fallbackMsg);
                queueAudioResponse(fallbackMsg);
                
                // Prepare for potential new image generation
                conversationHistory.push({
                    type: 'significant_edit_failed',
                    instruction: instruction,
                    timestamp: new Date()
                });
            } finally {
                isGenerating = false;
                hideGeneratingOverlay();
            }
        }

        function displayImage(imageUrl) {
            const imageDisplay = document.getElementById('imageDisplay');
            imageDisplay.innerHTML = `<img src="${imageUrl}" alt="Generated image">`;
            document.getElementById('imageActions').style.display = 'flex';
        }

        function showGeneratingOverlay(message = 'Generating...') {
            const imageDisplay = document.getElementById('imageDisplay');
            const overlay = document.createElement('div');
            overlay.className = 'generating-overlay';
            overlay.id = 'generatingOverlay';
            overlay.innerHTML = `
                <div class="spinner"></div>
                <p>${message}</p>
            `;
            imageDisplay.appendChild(overlay);
        }

        function hideGeneratingOverlay() {
            const overlay = document.getElementById('generatingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Audio queue management
        function queueAudioResponse(text) {
            audioQueue.push(text);
            if (!isPlayingAudio) {
                playNextAudio();
            }
        }

        async function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlayingAudio = false;
                return;
            }
            
            isPlayingAudio = true;
            const text = audioQueue.shift();
            
            try {
                const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/cgSgspJ2msm6clMCkdW9', {
                    method: 'POST',
                    headers: {
                        'xi-api-key': elevenlabsApiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_turbo_v2",
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75
                        }
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onended = () => {
                        playNextAudio(); // Play next in queue
                    };
                    
                    await audio.play();
                } else {
                    playNextAudio(); // Skip to next if error
                }
            } catch (error) {
                console.error('Error playing audio:', error);
                playNextAudio(); // Skip to next if error
            }
        }

        function downloadCurrentImage() {
            if (currentImage) {
                const a = document.createElement('a');
                a.href = currentImage;
                a.download = 'vibe-draw-creation.jpg';
                a.click();
            }
        }

        function startNewImage() {
            // Confirm before clearing everything
            const hasContent = currentImage || conversationHistory.length > 1;
            
            if (hasContent) {
                const confirmReset = confirm(
                    'Start a new session?\n\n' +
                    'This will clear your current image and conversation history.'
                );
                
                if (!confirmReset) return;
            }
            
            currentImage = null;
            updateModeIndicator('create');
            
            // Clear the chat history but keep the welcome message
            conversationHistory = [];
            document.getElementById('chatContainer').innerHTML = '';
            
            // Clear any pending audio
            audioQueue = [];
            
            // Reset image display
            document.getElementById('imageDisplay').innerHTML = `
                <div class="image-placeholder">
                    <svg fill="currentColor" viewBox="0 0 24 24" opacity="0.3">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    <p>Your image will appear here</p>
                </div>
            `;
            document.getElementById('imageActions').style.display = 'none';
            
            // Add a fresh start message
            const msg = getRandomResponse('newSession');
            addMessage('ai', msg);
            queueAudioResponse(msg);
            
            // Add system message with variety
            const sessionMessages = [
                'New session started',
                'Fresh canvas ready',
                'Starting over',
                'Clean slate activated',
                'New creation session'
            ];
            addMessage('system', sessionMessages[Math.floor(Math.random() * sessionMessages.length)]);
        }

        function updateModeIndicator(mode) {
            const indicator = document.getElementById('modeIndicator');
            if (mode === 'edit') {
                indicator.textContent = 'Edit Mode';
                indicator.className = 'mode-indicator edit';
            } else {
                indicator.textContent = 'Create Mode';
                indicator.className = 'mode-indicator create';
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const button = document.getElementById('debugToggle');
            button.textContent = `Debug: ${debugMode ? 'ON' : 'OFF'}`;
            
            // Override console.log based on debug mode
            if (debugMode) {
                console.log('🔧 Debug mode enabled');
            }
        }

        // Custom logging function
        const debugLog = (...args) => {
            if (debugMode) {
                console.log(...args);
            }
        };

        function showSettings() {
            const confirmChange = confirm(
                'Do you want to change your API keys?\n\n' +
                'Click OK to go back to setup.\n' +
                'Click Cancel to stay in the app.'
            );
            
            if (confirmChange) {
                // Clear current session
                currentImage = null;
                conversationHistory = [];
                audioQueue = [];
                isPlayingAudio = false;
                
                // Show setup panel again
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('debugToggle').classList.add('hidden');
                document.getElementById('setupPanel').style.display = 'block';
                
                // Pre-fill the current keys
                document.getElementById('elevenlabsKey').value = elevenlabsApiKey || '';
                document.getElementById('falKey').value = falApiKey || '';
                
                // Show clear keys button if we have saved keys
                const hasSavedKeys = localStorage.getItem('vibeDrawElevenLabsKey') || localStorage.getItem('vibeDrawFalKey');
                document.getElementById('clearKeysButton').hidden = !hasSavedKeys;
                
                // Clear the chat container
                document.getElementById('chatContainer').innerHTML = '';
                
                // Reset image display
                document.getElementById('imageDisplay').innerHTML = `
                    <div class="image-placeholder">
                        <svg fill="currentColor" viewBox="0 0 24 24" opacity="0.3">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <p>Your image will appear here</p>
                    </div>
                `;
                document.getElementById('imageActions').style.display = 'none';
                updateModeIndicator('create');
            }
        }

        function clearAPIKeys() {
            const confirmClear = confirm(
                'Are you sure you want to clear your saved API keys?\n\n' +
                'You will need to enter them again next time you use the app.'
            );
            
            if (confirmClear) {
                localStorage.removeItem('vibeDrawElevenLabsKey');
                localStorage.removeItem('vibeDrawFalKey');
                
                // Clear the input fields
                document.getElementById('elevenlabsKey').value = '';
                document.getElementById('falKey').value = '';
                
                // Hide the clear button
                document.getElementById('clearKeysButton').hidden = true;
                
                // Uncheck the remember checkbox
                document.getElementById('rememberKeys').checked = false;
                
                alert('API keys have been cleared from browser storage.');
            }
        }
    </script>
</body>
</html>